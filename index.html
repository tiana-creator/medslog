<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â≠ïÊúü‰øùÂÅ•Â∞èÂπ´Êâã</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #fff5f7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        #root { width: 100%; max-width: 400px; }
        .card {
            background: white;
            padding: 18px;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(240, 98, 146, 0.1);
            border: 1px solid #ffeef2;
            transition: all 0.3s ease;
        }
        .card.completed { border-color: #eee; box-shadow: none; background: #fdfdfd; }
        .card.waiting { border: 2px solid #ffc1d3; }
        .title { color: #d63384; text-align: center; margin-bottom: 25px; }
        .item-name { font-size: 16px; font-weight: 600; color: #444; }
        .completed .item-name { color: #bbb; text-decoration: line-through; }
        .time-label { font-size: 12px; color: #e91e63; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; }
        .time-badge { background: #fce4ec; color: #d81b60; padding: 2px 8px; border-radius: 4px; margin: 0 5px; }
        .btn-take {
            background-color: #f06292;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(240, 98, 146, 0.3);
        }
        .btn-take:disabled { background-color: #ffb2cc; box-shadow: none; opacity: 0.8; }
        .status-row { display: flex; align-items: center; margin-top: 8px; }
        .time-input {
            border: none;
            color: #28a745;
            font-weight: bold;
            font-size: 14px;
            background: #f0fff4;
            padding: 2px 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-reset {
            width: 100%;
            background: none;
            border: none;
            color: #bbb;
            text-decoration: underline;
            margin-top: 30px;
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const INITIAL_DATA = [
            { id: 1, name: "Á©∫ËÖπÔºöÁáïÁ™© + ËÜ†ÂéüËõãÁôΩ", type: "fasting", status: "pending", lastTaken: null },
            { id: 2, name: "Êó©‰∏ä‰∏≠Ëó• (3Âåô)", type: "herb", status: "pending", lastTaken: null },
            { id: 3, name: "Êó©È§êÂæåÔºöÊñ∞ÂØ∂Á¥çÂ§ö + ËóªÊ≤π", type: "iron", status: "pending", lastTaken: null },
            { id: 4, name: "Âçà/ÊôöÈ§êÂæåÔºöÂ•ΩËèå + BÈêµÈãÖ", type: "iron", status: "pending", lastTaken: null },
            { id: 5, name: "Êôö‰∏ä‰∏≠Ëó• (3Âåô)", type: "herb", status: "pending", lastTaken: null },
            { id: 6, name: "Áù°ÂâçÔºöÈõôÈà£ÈéÇ + ÈÄüÈéÇËÜ†Âõä", type: "calcium", status: "pending", lastTaken: null }
        ];

        function App() {
            const [items, setItems] = useState([]);
            const [lastTakenInfo, setLastTakenInfo] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const savedData = localStorage.getItem("preg_pills");
                const savedInfo = localStorage.getItem("preg_info");
                const savedDate = localStorage.getItem("preg_date");
                const today = new Date().toDateString();

                if (savedData && savedDate === today) {
                    setItems(JSON.parse(savedData));
                    if (savedInfo) setLastTakenInfo(JSON.parse(savedInfo));
                } else {
                    setItems(INITIAL_DATA);
                    setLastTakenInfo(null);
                    localStorage.setItem("preg_date", today);
                }

                const timer = setInterval(() => setCurrentTime(new Date()), 30000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (items.length > 0) {
                    localStorage.setItem("preg_pills", JSON.stringify(items));
                    localStorage.setItem("preg_info", JSON.stringify(lastTakenInfo));
                }
            }, [items, lastTakenInfo]);

            const handleTake = (id, index) => {
                const now = new Date();
                updateItem(id, index, now);
            };

            const updateItem = (id, index, dateObj) => {
                const timeStr = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                const waitMins = (items[index].type === "iron" || items[index].type === "calcium") ? 120 : 60;
                
                setLastTakenInfo({ index, targetTime: dateObj.getTime() + (waitMins * 60000) });
                setItems(items.map(item => item.id === id ? { ...item, status: "completed", lastTaken: timeStr } : item));
            };

            const handleUndo = (id) => {
                setItems(items.map(item => item.id === id ? { ...item, status: "pending", lastTaken: null } : item));
                setLastTakenInfo(null);
            };

            return (
                <div>
                    <h2 className="title">ü§∞ Â≠ïÊúü‰øùÂÅ•Ê∏ÖÂñÆ</h2>
                    {items.map((item, index) => {
                        const isNext = lastTakenInfo && index === lastTakenInfo.index + 1;
                        const isWaiting = isNext && currentTime.getTime() < lastTakenInfo.targetTime;
                        const targetStr = isNext ? new Date(lastTakenInfo.targetTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                        return (
                            <div key={item.id} className={`card ${item.status === 'completed' ? 'completed' : ''} ${isWaiting ? 'waiting' : ''}`}>
                                {isWaiting && (
                                    <div className="time-label">
                                        ‚è≥ Âª∫Ë≠∞Êñº <span className="time-badge">{targetStr}</span> ÂæåÊúçÁî®
                                    </div>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div style={{ flex: 1 }}>
                                        <div className="item-name">{item.name}</div>
                                        {item.status === 'completed' && (
                                            <div className="status-row">
                                                <input 
                                                    type="time" 
                                                    className="time-input" 
                                                    value={item.lastTaken} 
                                                    onChange={(e) => {
                                                        const [h, m] = e.target.value.split(':');
                                                        const d = new Date(); d.setHours(h, m);
                                                        updateItem(item.id, index, d);
                                                    }}
                                                />
                                                <button onClick={() => handleUndo(item.id)} style={{marginLeft:'10px', background:'none', border:'none', color:'#bbb', fontSize:'11px', cursor:'pointer'}}>Êí§Èä∑</button>
                                            </div>
                                        )}
                                    </div>
                                    {item.status === 'pending' && (
                                        <button className="btn-take" onClick={() => handleTake(item.id, index)} disabled={isWaiting}>
                                            ÂêÉÈÅé‰∫Ü
                                        </button>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                    <button className="btn-reset" onClick={() => { if(confirm("Á¢∫ÂÆöÈáçÁΩÆ‰ªäÊó•Ê∏ÖÂñÆÔºü")) { setItems(INITIAL_DATA); setLastTakenInfo(null); } }}>ÊâãÂãïÈáçÁΩÆ‰ªäÊó•Á¥ÄÈåÑ</button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

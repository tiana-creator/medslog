<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­•æœŸä¿å¥å°å¹«æ‰‹</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #fff5f7; font-family: -apple-system, sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        #root { width: 100%; max-width: 400px; }
        .card { background: white; padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(240, 98, 146, 0.1); border: 1px solid #ffeef2; position: relative; }
        .card.completed { border-color: #eee; box-shadow: none; background: #fdfdfd; }
        .card.waiting { border: 2px solid #ffc1d3; }
        .title { color: #d63384; text-align: center; margin-bottom: 25px; }
        .item-name { font-size: 16px; font-weight: 600; color: #444; }
        .completed .item-name { color: #bbb; text-decoration: line-through; }
        .time-label { font-size: 12px; color: #e91e63; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .time-badge { background: #fce4ec; color: #d81b60; padding: 2px 8px; border-radius: 4px; }
        .btn-take { background-color: #f06292; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(240, 98, 146, 0.3); }
        .btn-alarm { background: #d63384; color: #fff; border: none; padding: 4px 12px; border-radius: 12px; font-size: 11px; cursor: pointer; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .time-input { border: none; color: #28a745; font-weight: bold; font-size: 14px; background: #f0fff4; padding: 2px 5px; border-radius: 4px; }
        .btn-reset { width: 100%; background: none; border: none; color: #bbb; text-decoration: underline; margin-top: 30px; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const INITIAL_DATA = [
            { id: 1, name: "ç©ºè…¹ï¼šç‡•çª© + è† åŸè›‹ç™½", type: "short", status: "pending", lastTaken: null },
            { id: 2, name: "æ—©ä¸Šä¸­è—¥ (3åŒ™)", type: "short", status: "pending", lastTaken: null },
            { id: 3, name: "æ—©é¤å¾Œï¼šæ–°å¯¶ç´å¤š + è—»æ²¹", type: "long", status: "pending", lastTaken: null },
            { id: 4, name: "åˆ/æ™šé¤å¾Œï¼šå¥½èŒ + Béµé‹…", type: "short", status: "pending", lastTaken: null },
            { id: 5, name: "æ™šä¸Šä¸­è—¥ (3åŒ™)", type: "medium", status: "pending", lastTaken: null },
            { id: 6, name: "ç¡å‰ï¼šé›™éˆ£é‚ + é€Ÿé‚è† å›Š", type: "none", status: "pending", lastTaken: null }
        ];

        function App() {
            const [items, setItems] = useState([]);
            const [lastTakenInfo, setLastTakenInfo] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const savedData = localStorage.getItem("preg_pills_v6");
                const savedInfo = localStorage.getItem("preg_info_v6");
                const savedDate = localStorage.getItem("preg_date_v6");
                const today = new Date().toDateString();

                if (savedData && savedDate === today) {
                    setItems(JSON.parse(savedData));
                    if (savedInfo) setLastTakenInfo(JSON.parse(savedInfo));
                } else {
                    setItems(INITIAL_DATA); setLastTakenInfo(null);
                    localStorage.setItem("preg_date_v6", today);
                }
                const timer = setInterval(() => setCurrentTime(new Date()), 10000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (items.length > 0) {
                    localStorage.setItem("preg_pills_v6", JSON.stringify(items));
                    localStorage.setItem("preg_info_v6", JSON.stringify(lastTakenInfo));
                }
            }, [items, lastTakenInfo]);

            const updateItem = (id, index, dateObj) => {
                const timeStr = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                const type = items[index].type;
                const waitMins = type === "short" ? 60 : (type === "medium" ? 120 : (type === "long" ? 240 : 0));
                
                if (waitMins > 0) {
                    setLastTakenInfo({ index, targetTime: dateObj.getTime() + (waitMins * 60000) });
                } else {
                    setLastTakenInfo(null);
                }
                setItems(items.map(item => item.id === id ? { ...item, status: "completed", lastTaken: timeStr } : item));
            };

            const setReminder = (targetName, timestamp) => {
                const targetDate = new Date(timestamp);
                const title = encodeURIComponent(`ğŸ’Š è©²åƒä¿å¥é£Ÿå“å›‰ï¼š${targetName}`);
                
                // æ ¼å¼åŒ–æ™‚é–“ç‚º ISO æ ¼å¼ä½†ç§»é™¤ç¬¦è™Ÿ (YYYYMMDDTHHMMSSZ)
                const startTime = targetDate.toISOString().replace(/-|:|\.\d+/g, '');
                // çµæŸæ™‚é–“è¨­ç‚º 5 åˆ†é˜å¾Œ
                const endTime = new Date(timestamp + 5 * 60000).toISOString().replace(/-|:|\.\d+/g, '');
                
                // åŠ å…¥ã€Œè¡Œç¨‹ç•¶ä¸‹æé†’ã€çš„åƒæ•¸ (add=0)
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startTime}/${endTime}&details=å­•æœŸå¥åº·æé†’&add=0`;
                
                window.open(url, '_blank');
            };

            return (
                <div>
                    <h2 className="title">ğŸ¤° å­•æœŸä¿å¥æ¸…å–®</h2>
                    {items.map((item, index) => {
                        const isNext = lastTakenInfo && index === lastTakenInfo.index + 1;
                        const isWaiting = isNext && currentTime.getTime() < lastTakenInfo.targetTime;
                        const targetStr = isNext ? new Date(lastTakenInfo.targetTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                        return (
                            <div key={item.id} className={`card ${item.status === 'completed' ? 'completed' : ''} ${isWaiting ? 'waiting' : ''}`}>
                                {isWaiting && (
                                    <div className="time-label">
                                        <span>â³ å»ºè­° <span className="time-badge">{targetStr}</span> å¾Œåƒ</span>
                                        <button className="btn-alarm" onClick={() => setReminder(item.name, lastTakenInfo.targetTime)}>ğŸ”” ç•¶ä¸‹æé†’</button>
                                    </div>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div style={{ flex: 1 }}>
                                        <div className="item-name">{item.name}</div>
                                        {item.status === 'completed' && (
                                            <div style={{ marginTop: '8px', display: 'flex', alignItems: 'center' }}>
                                                <input type="time" className="time-input" value={item.lastTaken} 
                                                    onChange={(e) => {
                                                        const [h, m] = e.target.value.split(':');
                                                        const d = new Date(); d.setHours(h, m);
                                                        updateItem(item.id, index, d);
                                                    }}
                                                />
                                                <button onClick={() => {setItems(items.map(i => i.id === item.id ? {...i, status:'pending', lastTaken:null} : i)); setLastTakenInfo(null);}} style={{marginLeft:'10px', background:'none', border:'none', color:'#bbb', fontSize:'11px', cursor:'pointer'}}>æ’¤éŠ·</button>
                                            </div>
                                        )}
                                    </div>
                                    {item.status === 'pending' && (
                                        <button className={`btn-take ${isWaiting ? 'waiting-style' : ''}`} onClick={() => updateItem(item.id, index, new Date())}>åƒéäº†</button>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                    <button className="btn-reset" onClick={() => { if(confirm("ç¢ºå®šé‡ç½®ç´€éŒ„ï¼Ÿ")) { setItems(INITIAL_DATA); setLastTakenInfo(null); } }}>æ‰‹å‹•é‡ç½®ä»Šæ—¥ç´€éŒ„</button>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

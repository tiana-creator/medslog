import React, { useState, useEffect } from "react";

const INITIAL_DATA = [
  { id: 1, name: "ç©ºè…¹ï¼šç‡•çª© + è† åŸè›‹ç™½", type: "fasting", status: "pending", lastTaken: null, takenTimestamp: null },
  { id: 2, name: "æ—©ä¸Šä¸­è—¥ (3åŒ™)", type: "herb", status: "pending", lastTaken: null, takenTimestamp: null },
  { id: 3, name: "æ—©é¤å¾Œï¼šæ–°å¯¶ç´å¤š + è—»æ²¹", type: "iron", status: "pending", lastTaken: null, takenTimestamp: null },
  { id: 4, name: "åˆ/æ™šé¤å¾Œï¼šå¥½èŒ + Béµé‹…", type: "iron", status: "pending", lastTaken: null, takenTimestamp: null },
  { id: 5, name: "æ™šä¸Šä¸­è—¥ (3åŒ™)", type: "herb", status: "pending", lastTaken: null, takenTimestamp: null },
  { id: 6, name: "ç¡å‰ï¼šé›™éˆ£é‚ + é€Ÿé‚è† å›Š", type: "calcium", status: "pending", lastTaken: null, takenTimestamp: null }
];

export default function App() {
  const [items, setItems] = useState([]);
  const [view, setView] = useState("today"); // "today" æˆ– "history"
  const [history, setHistory] = useState({});
  const [currentTime, setCurrentTime] = useState(new Date());
  const [lastTakenInfo, setLastTakenInfo] = useState(null);

  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 30000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    const savedData = localStorage.getItem("pregnancy_pills_data");
    const savedInfo = localStorage.getItem("last_taken_info");
    const savedHistory = localStorage.getItem("pregnancy_history");
    const savedDate = localStorage.getItem("pill_date");
    const today = new Date().toDateString();

    if (savedData && savedDate === today) {
      setItems(JSON.parse(savedData));
      if (savedInfo) setLastTakenInfo(JSON.parse(savedInfo));
    } else {
      // æ›æ—¥å­˜æª”é‚è¼¯
      if (savedDate && savedData) {
        saveDayToHistory(savedDate, JSON.parse(savedData));
      }
      setItems(INITIAL_DATA);
      setLastTakenInfo(null);
      localStorage.setItem("pill_date", today);
    }
    if (savedHistory) setHistory(JSON.parse(savedHistory));
  }, []);

  const saveDayToHistory = (dateStr, dayData) => {
    const completedCount = dayData.filter(i => i.status === 'completed').length;
    const newHistory = { ...history, [dateStr]: completedCount };
    setHistory(newHistory);
    localStorage.setItem("pregnancy_history", JSON.stringify(newHistory));
  };

  useEffect(() => {
    if (items.length > 0) {
      localStorage.setItem("pregnancy_pills_data", JSON.stringify(items));
      localStorage.setItem("last_taken_info", JSON.stringify(lastTakenInfo));
    }
  }, [items, lastTakenInfo]);

  const handleTake = (id, index) => {
    const now = new Date();
    updateItemTime(id, index, now);
  };

  const updateItemTime = (id, index, dateObj) => {
    const timeString = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
    const waitMinutes = (items[index].type === "iron" || items[index].type === "calcium") ? 120 : 60;
    
    setLastTakenInfo({ index, targetTime: dateObj.getTime() + waitMinutes * 60000 });
    
    setItems(items.map(item => item.id === id ? 
      { ...item, status: "completed", lastTaken: timeString, takenTimestamp: dateObj.getTime() } : item
    ));
  };

  const handleHistoryIcon = (count) => {
    if (count === 6) return "â­";
    if (count >= 3) return "ğŸ˜Š";
    return "â­•";
  };

  return (
    <div style={{ maxWidth: '400px', margin: '0 auto', padding: '20px', backgroundColor: '#fff5f7', minHeight: '100vh', fontFamily: '-apple-system, sans-serif' }}>
      <div style={{ display: 'flex', justifyContent: 'center', gap: '10px', marginBottom: '20px' }}>
        <button onClick={() => setView("today")} style={{ padding: '8px 20px', borderRadius: '20px', border: 'none', backgroundColor: view === 'today' ? '#f06292' : '#ddd', color: 'white' }}>ä»Šæ—¥ç´€éŒ„</button>
        <button onClick={() => setView("history")} style={{ padding: '8px 20px', borderRadius: '20px', border: 'none', backgroundColor: view === 'history' ? '#f06292' : '#ddd', color: 'white' }}>æ‰“å¡æˆå°±</button>
      </div>

      {view === "today" ? (
        <div>
          <h2 style={{ color: '#d63384', textAlign: 'center' }}>ğŸ¤° ä»Šæ—¥ä¿å¥æ¸…å–®</h2>
          {items.map((item, index) => {
            const isNext = lastTakenInfo && index === lastTakenInfo.index + 1;
            const isWaiting = isNext && currentTime.getTime() < lastTakenInfo.targetTime;
            return (
              <div key={item.id} style={{ backgroundColor: '#fff', padding: '15px', borderRadius: '15px', marginBottom: '12px', border: isWaiting ? '1.5px solid #ffc1d3' : '1px solid #eee' }}>
                {isWaiting && <div style={{ fontSize: '12px', color: '#e91e63', marginBottom: '5px' }}>â³ å»ºè­°æ–¼ {new Date(lastTakenInfo.targetTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} å¾Œæœç”¨</div>}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <div style={{ fontWeight: '600', color: item.status === 'completed' ? '#bbb' : '#444' }}>{item.name}</div>
                    {item.status === 'completed' && (
                      <div style={{ display: 'flex', alignItems: 'center', marginTop: '5px' }}>
                        <input 
                          type="time" 
                          value={item.lastTaken} 
                          onChange={(e) => {
                            const [h, m] = e.target.value.split(':');
                            const newDate = new Date(); newDate.setHours(h, m);
                            updateItemTime(item.id, index, newDate);
                          }}
                          style={{ border: 'none', color: '#28a745', fontWeight: '500', backgroundColor: '#f0fff4', borderRadius: '4px' }}
                        />
                        <button onClick={() => {setItems(items.map(i => i.id === item.id ? {...i, status:'pending', lastTaken:null} : i)); setLastTakenInfo(null);}} style={{ marginLeft: '10px', background: 'none', border: 'none', fontSize: '10px', color: '#999' }}>æ’¤éŠ·</button>
                      </div>
                    )}
                  </div>
                  {item.status === 'pending' && (
                    <button onClick={() => handleTake(item.id, index)} style={{ backgroundColor: isWaiting ? '#ffb2cc' : '#f06292', color: 'white', border: 'none', padding: '8px 15px', borderRadius: '20px', cursor: 'pointer' }}>åƒéäº†</button>
                  )}
                </div>
              </div>
            );
          })}
          <button onClick={() => {if(window.confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { setItems(INITIAL_DATA); setLastTakenInfo(null); }}} style={{ width: '100%', marginTop: '20px', background: 'none', border: 'none', color: '#bbb', textDecoration: 'underline' }}>æ‰‹å‹•é‡ç½®ä»Šæ—¥ç´€éŒ„</button>
        </div>
      ) : (
        <div>
          <h2 style={{ color: '#d63384', textAlign: 'center' }}>ğŸ† æ‰“å¡æˆå°±ç‰†</h2>
          <div style={{ backgroundColor: '#fff', borderRadius: '15px', padding: '20px' }}>
            {Object.keys(history).length === 0 && <p style={{ textAlign: 'center', color: '#999' }}>æ˜å¤©æ›æ—¥å¾Œå°±æœƒå‡ºç¾ç´€éŒ„å›‰ï¼</p>}
            {Object.entries(history).reverse().map(([date, count]) => (
              <div key={date} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #eee' }}>
                <span style={{ color: '#666' }}>{new Date(date).toLocaleDateString()}</span>
                <span style={{ fontSize: '18px' }}>{handleHistoryIcon(count)} <small style={{ fontSize: '12px', color: '#999' }}>({count}/6)</small></span>
              </div>
            ))}
          </div>
          <div style={{ marginTop: '20px', fontSize: '13px', color: '#d63384', textAlign: 'center' }}>â­: å®Œç¾é”æˆ | ğŸ˜Š: è¶…éä¸€åŠ | â­•: åŠ æ²¹</div>
        </div>
      )}
    </div>
  );
}
